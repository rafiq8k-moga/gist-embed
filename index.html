<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gist Embed AES</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: Arial, sans-serif;
  }
    #input-section { max-width: 600px; margin-bottom: 20px; }
    label { display: block; margin-bottom: 6px; }
    input[type=text] { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { padding: 10px 20px; cursor: pointer; }
    #result { margin-top: 10px; padding: 10px; background: #f4f4f4; word-break: break-word; }
    iframe {
    position: fixed; /* supaya nempel fullscreen */
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100vw;
    height: 100vh;
    border: none;
    margin: 0;
    padding: 0;
    display: block;
    z-index: 9999;
  }
  </style>
</head>
<body>
  <h2>Gist Embed AES</h2>

  <div id="input-section" style="display:none;">
    <label for="gisturl">Masukkan link gist (format https://gist.github.com/username/gistid):</label>
    <input type="text" id="gisturl" placeholder="https://gist.github.com/rafiq8k-moga/c5f966c134ea9794633a4c039640179f" />
    <button id="generate">Generate Embed Link</button>
    <div id="result"></div>
  </div>

  <script>
    // Konfigurasi AES
    const key = CryptoJS.enc.Utf8.parse('oniichan-daisuki'); // 16 char key
    const iv = CryptoJS.enc.Utf8.parse('oniichan-daisuki');  // 16 char IV

    function encrypt(text) {
      return CryptoJS.AES.encrypt(text, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).toString();
    }

    function decrypt(ciphertext) {
      try {
        const decrypted = CryptoJS.AES.decrypt(ciphertext, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        return decrypted.toString(CryptoJS.enc.Utf8);
      } catch {
        return null;
      }
    }

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    const gistParam = getQueryParam('gist');

    if (!gistParam) {
      // Tampilkan UI input
      document.getElementById('input-section').style.display = 'block';

      document.getElementById('generate').onclick = () => {
        const url = document.getElementById('gisturl').value.trim();
        if (!url) {
          alert('Masukkan URL gist yang valid!');
          return;
        }
        // Validasi sederhana URL gist
        const gistRegex = /^https:\/\/gist\.github\.com\/([^\/]+)\/([a-f0-9]+)$/i;
        const match = url.match(gistRegex);
        if (!match) {
          alert('Format URL gist tidak valid!\nContoh: https://gist.github.com/username/gistid');
          return;
        }
        const username = match[1];
        const gistid = match[2];
        const closer = `>`;  
        const embedCode = `<script src="https://gist.github.com/${username}/${gistid}.js"></script${closer}`;
        const encrypted = encrypt(embedCode);
        const encoded = encodeURIComponent(encrypted);
        const embedUrl = `${location.origin}${location.pathname}?gist=${encoded}`;
        document.getElementById('result').innerHTML = `<b>Embed Link:</b> <a href="${embedUrl}" target="_blank">${embedUrl}</a>`;
      };
    } else {
      // Ada param gist, coba decrypt dan inject via iframe
      try {
        const encryptedDecoded = decodeURIComponent(gistParam);
        const embedCode = decrypt(encryptedDecoded);
        if (!embedCode) {
          document.body.innerHTML = '<h3 style="color:red;">Gagal decrypt parameter gist.</h3>';
        } else {
          const match = embedCode.match(/src="([^"]+)"/);
          if (match && match[1]) {
            const scriptSrc = match[1];
            const iframe = document.createElement('iframe');
            const closer = `>`; 
            iframe.srcdoc = `
              <html>
                <head><base target="_parent"></head>
                <body>
                  <script src="${scriptSrc}"></script${closer}
                </body>
              </html>
            `;
            document.body.innerHTML = ''; // bersihkan dulu body
            document.body.appendChild(iframe);
          } else {
            document.body.innerHTML = '<h3 style="color:red;">Embed code tidak valid.</h3>';
          }
        }
      } catch (e) {
        document.body.innerHTML = '<h3 style="color:red;">Error proses parameter gist.</h3>';
      }
    }
  </script>
</body>
</html>
